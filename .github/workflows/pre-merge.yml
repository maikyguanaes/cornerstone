name: pre-merge
on:
  pull_request:
    branches: ["**"]
    paths-ignore:
      - "**docs/**"
      - "**/README*"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10"]

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_dev.txt
      - name: Make .env
        shell: bash
        env:
          FLASK_APP: "cornerstone"
          FLASK_SECRET_KEY: "development key"
          FLASK_ENV: "development"
          FLASK_DEBUG: "false"
          FLASK_TESTING: "true"
          FLASK_RUN_PORT: "8080"
        run: |
          echo 'FLASK_APP=$FLASK_APP' >> .env
          echo 'FLASK_SECRET_KEY=$FLASK_SECRET_KEY' >> .env
          echo 'FLASK_ENV=$FLASK_ENV' >> .env
          echo 'FLASK_DEBUG=$FLASK_DEBUG' >> .env
          echo 'FLASK_TESTING=$FLASK_TESTING' >> .env
          echo 'FLASK_RUN_PORT=$FLASK_RUN_PORT' >> .env

      - name: Run test suite
        run: |
          pytest -vv
        env:
          COVERAGE_FILE: ".coverage.${{ matrix.python_version }}"
          # Alternatively you can run coverage with the --parallel flag or add
          # `parallel = True` in the coverage config file.
          # If using pytest-cov, you can also add the `--cov-append` flag
          # directly or through PYTEST_ADD_OPTS.

      - name: Store coverage file
        uses: actions/upload-artifact@v2
        with:
          name: coverage
          path: .coverage.${{ matrix.python_version }}

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v2

      - uses: actions/download-artifact@v2
        id: download
        with:
          name: 'coverage'

      - name: Coverage comment
        id: coverage_comment
        uses: ewjoachim/python-coverage-comment-action@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERBOSE: true
          MERGE_COVERAGE_FILES: true

      - name: Store Pull Request comment to be posted
        uses: actions/upload-artifact@v2
        if: steps.coverage_comment.outputs.COMMENT_FILE_WRITTEN == 'true'
        with:
          name: python-coverage-comment-action
          path: python-coverage-comment-action.txt
